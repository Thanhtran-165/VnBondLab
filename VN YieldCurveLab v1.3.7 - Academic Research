//@version=5
indicator("VN YieldCurveLab v1.4.2 - Academic Research Mode (Panel 2/3 restored)",
     shorttitle="VN YieldCurveLab",
     overlay=false, max_labels_count=400, max_lines_count=400, max_bars_back=5000, precision=4)

//======================================================
// 0) INPUTS
//======================================================
panel_view  = input.int(1, "Chon panel (1=Shape, 2=Grid, 3=Stats)", minval=1, maxval=3)
show_panel1 = panel_view == 1
show_panel2 = panel_view == 2
show_panel3 = panel_view == 3

sym_1Y  = input.symbol("TVC:VN01Y", "1Y Yield")
sym_2Y  = input.symbol("TVC:VN02Y", "2Y Yield")
sym_3Y  = input.symbol("TVC:VN03Y", "3Y Yield")
sym_5Y  = input.symbol("TVC:VN05Y", "5Y Yield")
sym_7Y  = input.symbol("TVC:VN07Y", "7Y Yield")
sym_10Y = input.symbol("TVC:VN10Y", "10Y Yield")

sym_interbank = input.symbol("VNINBR", "Interbank (VNINBR)")
sym_policy    = input.symbol("VNINTR", "Policy Rate (VNINTR)")

len_stats   = input.int(120, "Len stats (days)", minval=30)
clip_mult   = input.float(2.5, "Clip multiplier (robust z)", minval=1.0, maxval=5.0)
use_percent = input.bool(true, "Use percentile (0-100%)")
len_change  = input.int(60, "Change window (days)", minval=5)

low_th_pct  = input.float(20.0, "Percentile LOW",  minval=0.0,  maxval=50.0)
high_th_pct = input.float(80.0, "Percentile HIGH", minval=50.0, maxval=100.0)
len_deriv   = input.int(5, "Momentum window (days)", minval=1, maxval=60)

// Display
show_yields_panel23 = input.bool(true, "Show yield time-series on Panel 2/3")  // <= FIX: default true
show_line_labels    = input.bool(true,  "Show line labels (ticker only)")
label_all_tenors    = input.bool(false, "Label 1Y/3Y/7Y too")
label_offset_bars   = input.int(6, "Label offset bars", minval=1, maxval=50)

// Snapshot
show_curve_snapshot = input.bool(true, "Panel 1: show curve snapshot (right side)")
snap_x_offset       = input.int(12, "Snapshot x offset (bars)", minval=5, maxval=50)
snap_x_step         = input.int(2, "Snapshot x step (bars)", minval=1, maxval=10)

// Stress overlay
show_stress_overlay = input.bool(true, "Show stress overlay (mapped to yield scale)")

tf_req = "D"

//======================================================
// 1) HELPERS (ASCII-safe)
//======================================================
f_robust_zscore(src, length, clip) =>
    _mean = ta.sma(src, length)
    _std  = ta.stdev(src, length)
    upper = _mean + clip * _std
    lower = _mean - clip * _std
    clipped = math.max(lower, math.min(upper, src))
    c_mean = ta.sma(clipped, length)
    c_std  = ta.stdev(clipped, length)
    float out = 0.0
    if c_std > 0
        out := (src - c_mean) / c_std
    out

f_pct_str(v) =>
    string s = "NA"
    if not na(v)
        s := str.tostring(v, "#.0") + "%"
    s

f_num_str(v, fmt) =>
    string s = "NA"
    if not na(v)
        s := str.tostring(v, fmt)
    s

f_arrow_ascii(d) =>
    string a = "-"
    if not na(d)
        if d > 0.01
            a := "UP"
        else if d < -0.01
            a := "DN"
        else
            a := "-"
    a

f_bucket_pct(p, low_th, high_th) =>
    string b = "NA"
    if not na(p)
        if p <= low_th
            b := "LOW"
        else if p >= high_th
            b := "HIGH"
        else
            b := "MID"
    b

f_bucket_z(z) =>
    string b = "NA"
    if not na(z)
        if z <= -1.0
            b := "CHEAP"
        else if z >= 1.0
            b := "RICH"
        else
            b := "FAIR"
    b

f_bg_state(tag) =>
    color out = color.new(color.gray, 85)
    if tag == "HIGH" or tag == "RICH" or tag == "STRESS CAO" or tag == "YC4" or tag == "INVERTED" or tag == "DISTORTED" or tag == "LOWQ"
        out := color.new(color.red, 10)
    else if tag == "MID" or tag == "FAIR" or tag == "TRUNG TINH" or tag == "YC0" or tag == "FLAT" or tag == "MIXED" or tag == "MEDQ"
        out := color.new(color.orange, 15)
    else if tag == "LOW" or tag == "CHEAP" or tag == "STRESS THAP" or tag == "YC1" or tag == "YC2" or tag == "PURE MOVE" or tag == "HIGHQ"
        out := color.new(color.lime, 12)
    else if tag == "YC3"
        out := color.new(color.fuchsia, 15)
    out

f_cell(_t, _c, _r, _txt, _bg, _tc, _ha, _sz) =>
    table.cell(_t, _c, _r, _txt, bgcolor=_bg, text_color=_tc, text_halign=_ha, text_size=_sz)

f_updLabel(_lbl, _x, _y, _txt, _col) =>
    label __l = _lbl
    if na(_y)
        if not na(__l)
            label.delete(__l)
            __l := na
    else
        if na(__l)
            __l := label.new(_x, _y, _txt,
                 xloc=xloc.bar_index, yloc=yloc.price,
                 style=label.style_label_left,
                 textcolor=color.white,
                 color=color.new(_col, 0),
                 size=size.tiny)
        else
            label.set_xy(__l, _x, _y)
            label.set_text(__l, _txt)
            label.set_color(__l, color.new(_col, 0))
            label.set_textcolor(__l, color.white)
            label.set_style(__l, label.style_label_left)
            label.set_size(__l, size.tiny)
    __l

f_bar(pct, width) =>
    float p = math.max(0.0, math.min(100.0, pct))
    int filled = int(math.round((p / 100.0) * width))
    string s = ""
    for i = 0 to width - 1
        s += i < filled ? "|" : "."
    s

//======================================================
// 2) DATA
//======================================================
y1  = request.security(sym_1Y,  tf_req, close, barmerge.gaps_off, barmerge.lookahead_off)
y2  = request.security(sym_2Y,  tf_req, close, barmerge.gaps_off, barmerge.lookahead_off)
y3  = request.security(sym_3Y,  tf_req, close, barmerge.gaps_off, barmerge.lookahead_off)
y5  = request.security(sym_5Y,  tf_req, close, barmerge.gaps_off, barmerge.lookahead_off)
y7  = request.security(sym_7Y,  tf_req, close, barmerge.gaps_off, barmerge.lookahead_off)
y10 = request.security(sym_10Y, tf_req, close, barmerge.gaps_off, barmerge.lookahead_off)

interbank = request.security(sym_interbank, tf_req, close, barmerge.gaps_off, barmerge.lookahead_off)
policy    = request.security(sym_policy,    tf_req, close, barmerge.gaps_off, barmerge.lookahead_off)

//======================================================
// 3) FACTORS + STATS
//======================================================
level = (y2 + y5 + y10) / 3.0
slope = y10 - y2
curve = 2.0 * y5 - y2 - y10

level_z = f_robust_zscore(level, len_stats, clip_mult)
slope_z = f_robust_zscore(slope, len_stats, clip_mult)
curve_z = f_robust_zscore(curve, len_stats, clip_mult)

float level_pct = na
float slope_pct = na
float curve_pct = na
if use_percent
    level_pct := ta.percentrank(level, len_stats)
    slope_pct := ta.percentrank(slope, len_stats)
    curve_pct := ta.percentrank(curve, len_stats)

float level_d = na
float slope_d = na
float curve_d = na
if not na(level[len_deriv])
    level_d := level - level[len_deriv]
if not na(slope[len_deriv])
    slope_d := slope - slope[len_deriv]
if not na(curve[len_deriv])
    curve_d := curve - curve[len_deriv]

//======================================================
// 4) REGIME + STRESS
//======================================================
string level_regime = "MID"
if not na(level_pct)
    if level_pct <= low_th_pct
        level_regime := "LOW"
    else if level_pct >= high_th_pct
        level_regime := "HIGH"
    else
        level_regime := "MID"

string slope_regime = "FLAT"
if slope <= -0.2
    slope_regime := "INVERTED"
else
    if not na(slope_pct)
        if slope_pct <= low_th_pct
            slope_regime := "STEEP_LOW"
        else if slope_pct >= high_th_pct
            slope_regime := "STEEP_HIGH"
        else
            slope_regime := "FLAT"

string yc_code  = "YC0"
string yc_label = "Neutral/Mixed."
if level_regime == "HIGH" and (slope_regime == "FLAT" or slope_regime == "INVERTED")
    yc_code  := "YC4"
    yc_label := "Tight: high level + flat/inverted."
else if level_regime == "HIGH" and slope_regime == "STEEP_HIGH"
    yc_code  := "YC3"
    yc_label := "Late tightening: high level + steep."
else if level_regime == "LOW" and slope_regime == "STEEP_HIGH"
    yc_code  := "YC2"
    yc_label := "Early easing: low level + steep."
else if level_regime == "LOW" and (slope_regime == "FLAT" or slope_regime == "STEEP_LOW")
    yc_code  := "YC1"
    yc_label := "Easing mature: low level + flat."

float level_comp = not na(level_pct) ? level_pct : 50.0
float slope_risk_pct = slope <= 0.0 ? 100.0 : (not na(slope_pct) ? (100.0 - slope_pct) : 50.0)
macro_stress = (level_comp + slope_risk_pct) / 2.0

string stress_regime = "TRUNG TINH"
if macro_stress >= 70
    stress_regime := "STRESS CAO"
else if macro_stress <= 40
    stress_regime := "STRESS THAP"

//======================================================
// 5) GRID + DISTORTION + QUALITY
//======================================================
y1_z  = f_robust_zscore(y1,  len_stats, clip_mult)
y2_z  = f_robust_zscore(y2,  len_stats, clip_mult)
y3_z  = f_robust_zscore(y3,  len_stats, clip_mult)
y5_z  = f_robust_zscore(y5,  len_stats, clip_mult)
y7_z  = f_robust_zscore(y7,  len_stats, clip_mult)
y10_z = f_robust_zscore(y10, len_stats, clip_mult)

float y1_pct = na
float y2_pct = na
float y3_pct = na
float y5_pct = na
float y7_pct = na
float y10_pct = na
if use_percent
    y1_pct  := ta.percentrank(y1,  len_stats)
    y2_pct  := ta.percentrank(y2,  len_stats)
    y3_pct  := ta.percentrank(y3,  len_stats)
    y5_pct  := ta.percentrank(y5,  len_stats)
    y7_pct  := ta.percentrank(y7,  len_stats)
    y10_pct := ta.percentrank(y10, len_stats)

float chg1  = not na(y1[len_change])  ? (y1  - y1[len_change])  : na
float chg2  = not na(y2[len_change])  ? (y2  - y2[len_change])  : na
float chg3  = not na(y3[len_change])  ? (y3  - y3[len_change])  : na
float chg5  = not na(y5[len_change])  ? (y5  - y5[len_change])  : na
float chg7  = not na(y7[len_change])  ? (y7  - y7[len_change])  : na
float chg10 = not na(y10[len_change]) ? (y10 - y10[len_change]) : na

mean_z = (y1_z + y2_z + y3_z + y5_z + y7_z + y10_z) / 6.0
dz1  = y1_z  - mean_z
dz2  = y2_z  - mean_z
dz3  = y3_z  - mean_z
dz5  = y5_z  - mean_z
dz7  = y7_z  - mean_z
dz10 = y10_z - mean_z
var_z = (dz1*dz1 + dz2*dz2 + dz3*dz3 + dz5*dz5 + dz7*dz7 + dz10*dz10) / 6.0
yc_distortion = math.sqrt(var_z)

string dist_label = yc_distortion < 0.30 ? "PURE MOVE" : yc_distortion > 0.70 ? "DISTORTED" : "MIXED"
float dist_clamp = math.min(1.2, math.max(0.0, yc_distortion))
signal_quality = 100.0 - (dist_clamp / 1.2) * 100.0
string quality_label = signal_quality >= 75 ? "HIGHQ" : signal_quality >= 50 ? "MEDQ" : "LOWQ"

float short_move = (not na(chg1) and not na(chg2)) ? ((math.abs(chg1) + math.abs(chg2))/2.0) : na
float belly_move = (not na(chg3) and not na(chg5)) ? ((math.abs(chg3) + math.abs(chg5))/2.0) : na
float long_move  = (not na(chg7) and not na(chg10)) ? ((math.abs(chg7) + math.abs(chg10))/2.0) : na

string move_focus = "NA"
if not na(short_move) and not na(belly_move) and not na(long_move)
    move_focus := "SHORT"
    if belly_move > short_move and belly_move >= long_move
        move_focus := "BELLY"
    else if long_move > short_move and long_move > belly_move
        move_focus := "LONG"

float slope_chg = (not na(y10[len_change]) and not na(y2[len_change])) ? ((y10 - y2) - (y10[len_change] - y2[len_change])) : na
string curve_shift = na(slope_chg) ? "STABLE" : slope_chg > 0.10 ? "STEEPENING" : slope_chg < -0.10 ? "FLATTENING" : "STABLE"

//======================================================
// 6) PANE BACKGROUND (hint)
//======================================================
color bg_pane = na
if show_panel1
    bg_pane := yc_code == "YC4" ? color.new(color.red, 92) :
               yc_code == "YC2" ? color.new(color.lime, 92) :
               yc_code == "YC3" ? color.new(color.fuchsia, 93) :
               yc_code == "YC1" ? color.new(color.green, 93) :
                                  color.new(color.orange, 94)
bgcolor(bg_pane)

//======================================================
// 7) PLOTS (ALWAYS keep chart visible in Panel 2/3)
//======================================================
col2  = color.new(color.blue, 0)
col5  = color.new(color.green, 0)
col10 = color.new(color.red, 0)
col1  = color.new(color.gray, 60)
col3  = color.new(color.orange, 60)
col7  = color.new(color.purple, 60)
colIB = color.new(color.yellow, 0)
colPR = color.new(color.teal, 0)

bool show_yields_now = show_panel1 or (show_panel2 or show_panel3) and show_yields_panel23

plot(show_yields_now ? y2  : na, title="2Y",  color=col2,  linewidth=2)
plot(show_yields_now ? y5  : na, title="5Y",  color=col5,  linewidth=2)
plot(show_yields_now ? y10 : na, title="10Y", color=col10, linewidth=2)

plot(show_yields_now ? y1 : na, title="1Y", color=col1)
plot(show_yields_now ? y3 : na, title="3Y", color=col3)
plot(show_yields_now ? y7 : na, title="7Y", color=col7)

plot(show_yields_now ? interbank : na, title="VNINBR", color=colIB, linewidth=1)
plot(show_yields_now ? policy    : na, title="VNINTR", color=colPR, linewidth=1)

// Stress overlay mapped into yield scale (so it won't crush the axis)
float y_min = ta.lowest(math.min(y1, math.min(y2, math.min(y3, math.min(y5, math.min(y7, y10))))), len_stats)
float y_max = ta.highest(math.max(y1, math.max(y2, math.max(y3, math.max(y5, math.max(y7, y10))))), len_stats)
float y_rng = (y_max - y_min)
float stress_y = y_min + (macro_stress / 100.0) * (y_rng > 0 ? y_rng : 1.0)
plot((show_yields_now and show_stress_overlay) ? stress_y : na, title="Stress(mapped)", color=color.new(color.white, 30), linewidth=2, style=plot.style_line)

//======================================================
// 8) LINE LABELS (ticker only)
//======================================================
var label lb2  = na
var label lb5  = na
var label lb10 = na
var label lb1  = na
var label lb3  = na
var label lb7  = na
var label lbIB = na
var label lbPR = na

if barstate.islast and show_line_labels and show_yields_now
    xL = bar_index + label_offset_bars
    lb2  := f_updLabel(lb2,  xL, y2,  "2Y",     col2)
    lb5  := f_updLabel(lb5,  xL, y5,  "5Y",     col5)
    lb10 := f_updLabel(lb10, xL, y10, "10Y",    col10)

    if label_all_tenors
        lb1 := f_updLabel(lb1, xL, y1, "1Y", color.new(color.gray, 20))
        lb3 := f_updLabel(lb3, xL, y3, "3Y", color.new(color.orange, 20))
        lb7 := f_updLabel(lb7, xL, y7, "7Y", color.new(color.purple, 20))
    else
        if not na(lb1)
            label.delete(lb1), lb1 := na
        if not na(lb3)
            label.delete(lb3), lb3 := na
        if not na(lb7)
            label.delete(lb7), lb7 := na

    lbIB := f_updLabel(lbIB, xL, interbank, "VNINBR", colIB)
    lbPR := f_updLabel(lbPR, xL, policy,    "VNINTR", colPR)

//======================================================
// 9) CURVE SNAPSHOT (Panel 1 only)
//======================================================
var line l12 = na
var line l23 = na
var line l35 = na
var line l57 = na
var line l710 = na

var label s1n = na
var label s2n = na
var label s3n = na
var label s5n = na
var label s7n = na
var label s10n = na

if barstate.islast and show_panel1 and show_curve_snapshot
    x1s  = bar_index + snap_x_offset + 0 * snap_x_step
    x2s  = bar_index + snap_x_offset + 1 * snap_x_step
    x3s  = bar_index + snap_x_offset + 2 * snap_x_step
    x5s  = bar_index + snap_x_offset + 3 * snap_x_step
    x7s  = bar_index + snap_x_offset + 4 * snap_x_step
    x10s = bar_index + snap_x_offset + 5 * snap_x_step

    if na(l12)
        l12 := line.new(x1s, y1, x2s, y2, xloc=xloc.bar_index, extend=extend.none, color=color.new(color.white, 0), width=2)
        l23 := line.new(x2s, y2, x3s, y3, xloc=xloc.bar_index, extend=extend.none, color=color.new(color.white, 0), width=2)
        l35 := line.new(x3s, y3, x5s, y5, xloc=xloc.bar_index, extend=extend.none, color=color.new(color.white, 0), width=2)
        l57 := line.new(x5s, y5, x7s, y7, xloc=xloc.bar_index, extend=extend.none, color=color.new(color.white, 0), width=2)
        l710 := line.new(x7s, y7, x10s, y10, xloc=xloc.bar_index, extend=extend.none, color=color.new(color.white, 0), width=2)
    else
        line.set_xy1(l12, x1s, y1),  line.set_xy2(l12, x2s, y2)
        line.set_xy1(l23, x2s, y2),  line.set_xy2(l23, x3s, y3)
        line.set_xy1(l35, x3s, y3),  line.set_xy2(l35, x5s, y5)
        line.set_xy1(l57, x5s, y5),  line.set_xy2(l57, x7s, y7)
        line.set_xy1(l710, x7s, y7), line.set_xy2(l710, x10s, y10)

    s1n  := f_updLabel(s1n,  x1s,  y1,  "1Y",  color.new(color.gray, 20))
    s2n  := f_updLabel(s2n,  x2s,  y2,  "2Y",  col2)
    s3n  := f_updLabel(s3n,  x3s,  y3,  "3Y",  color.new(color.orange, 20))
    s5n  := f_updLabel(s5n,  x5s,  y5,  "5Y",  col5)
    s7n  := f_updLabel(s7n,  x7s,  y7,  "7Y",  color.new(color.purple, 20))
    s10n := f_updLabel(s10n, x10s, y10, "10Y", col10)

//======================================================
// 10) TABLES (unchanged logic, message-first)
//======================================================
var table t_shape = na
var table t_grid  = na
var table t_stats = na

bg_frame   = color.new(color.black, 0)
bg_title   = color.new(color.black, 10)
bg_header  = color.new(color.black, 25)
bg_row_a   = color.new(color.black, 18)
bg_row_b   = color.new(color.black, 28)
tc_main    = color.white
tc_muted   = color.new(color.white, 20)

if barstate.islast
    // Panel 1
    if show_panel1
        if na(t_shape)
            t_shape := table.new(position.top_left, 4, 10,
                 frame_width=2, frame_color=bg_frame,
                 border_width=1, border_color=color.new(color.white, 80))
            table.merge_cells(t_shape, 0, 0, 3, 0)
            table.merge_cells(t_shape, 0, 9, 3, 9)

        f_cell(t_shape, 0, 0, "P1 SHAPE DASHBOARD", bg_title, tc_main, text.align_left, size.small)
        for c = 1 to 3
            f_cell(t_shape, c, 0, "", bg_title, tc_main, text.align_left, size.small)

        f_cell(t_shape, 0, 1, "FACTOR", bg_header, tc_main, text.align_left,  size.tiny)
        f_cell(t_shape, 1, 1, "VALUE",  bg_header, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 2, 1, "PCTL",   bg_header, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 3, 1, "STATE",  bg_header, tc_main, text.align_left,  size.tiny)

        f_cell(t_shape, 0, 2, "LEVEL", bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 1, 2, f_num_str(level, "#.2"), bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 2, 2, f_pct_str(level_pct), bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 3, 2, level_regime, f_bg_state(level_regime), tc_main, text.align_left, size.tiny)

        f_cell(t_shape, 0, 3, "SLOPE(10-2)", bg_row_b, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 1, 3, f_num_str(slope, "#.2"), bg_row_b, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 2, 3, f_pct_str(slope_pct), bg_row_b, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 3, 3, slope_regime, f_bg_state(slope_regime), tc_main, text.align_left, size.tiny)

        f_cell(t_shape, 0, 4, "CURVE(2-5-10)", bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 1, 4, f_num_str(curve, "#.2"), bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 2, 4, f_pct_str(curve_pct), bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 3, 4, "BELLY", bg_row_a, tc_muted, text.align_left, size.tiny)

        f_cell(t_shape, 0, 5, "YC REGIME", bg_row_b, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 1, 5, yc_code, f_bg_state(yc_code), tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 2, 5, "", bg_row_b, tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 3, 5, yc_label, bg_row_b, tc_main, text.align_left, size.tiny)

        bar_txt = f_bar(macro_stress, 16)
        f_cell(t_shape, 0, 6, "STRESS", bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 1, 6, f_num_str(macro_stress, "#.0"), f_bg_state(stress_regime), tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 2, 6, bar_txt, bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 3, 6, stress_regime, f_bg_state(stress_regime), tc_main, text.align_left, size.tiny)

        f_cell(t_shape, 0, 7, "QUALITY", bg_row_b, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 1, 7, f_num_str(signal_quality, "#.0"), f_bg_state(quality_label), tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 2, 7, dist_label, f_bg_state(dist_label), tc_main, text.align_right, size.tiny)
        f_cell(t_shape, 3, 7, "Dist="+f_num_str(yc_distortion,"#.2"), bg_row_b, tc_main, text.align_left, size.tiny)

        f_cell(t_shape, 0, 8, "RATES", bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 1, 8, "VNINBR "+f_num_str(interbank,"#.2"), bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 2, 8, "VNINTR "+f_num_str(policy,"#.2"), bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_shape, 3, 8, "Focus "+move_focus, bg_row_a, tc_main, text.align_left, size.tiny)

        string p1_msg = "MESSAGE: "
        if quality_label == "LOWQ"
            p1_msg += "Noisy/segmented. Uu tien quan sat."
        else
            p1_msg += yc_code + " -> " + yc_label

        f_cell(t_shape, 0, 9, p1_msg, bg_title, tc_main, text.align_left, size.small)
        for c = 1 to 3
            f_cell(t_shape, c, 9, "", bg_title, tc_main, text.align_left, size.small)
    else
        if not na(t_shape)
            table.delete(t_shape), t_shape := na

    // Panel 2
    if show_panel2
        if na(t_grid)
            t_grid := table.new(position.top_left, 7, 9,
                 frame_width=2, frame_color=bg_frame,
                 border_width=1, border_color=color.new(color.white, 80))
            table.merge_cells(t_grid, 0, 0, 6, 0)
            table.merge_cells(t_grid, 0, 8, 6, 8)

        title_grid = "P2 HEATMAP GRID (chg=" + str.tostring(len_change) + "d)"
        f_cell(t_grid, 0, 0, title_grid, bg_title, tc_main, text.align_left, size.small)
        for c = 1 to 6
            f_cell(t_grid, c, 0, "", bg_title, tc_main, text.align_left, size.small)

        f_cell(t_grid, 0, 1, "METRIC", bg_header, tc_main, text.align_left, size.tiny)
        f_cell(t_grid, 1, 1, "1Y", bg_header, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 2, 1, "2Y", bg_header, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 3, 1, "3Y", bg_header, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 4, 1, "5Y", bg_header, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 5, 1, "7Y", bg_header, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 6, 1, "10Y", bg_header, tc_main, text.align_right, size.tiny)

        st1 = f_bucket_pct(y1_pct, low_th_pct, high_th_pct)
        st2 = f_bucket_pct(y2_pct, low_th_pct, high_th_pct)
        st3 = f_bucket_pct(y3_pct, low_th_pct, high_th_pct)
        st5 = f_bucket_pct(y5_pct, low_th_pct, high_th_pct)
        st7 = f_bucket_pct(y7_pct, low_th_pct, high_th_pct)
        st10 = f_bucket_pct(y10_pct, low_th_pct, high_th_pct)

        f_cell(t_grid, 0, 2, "STATE(PCTL)", bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_grid, 1, 2, st1,  f_bg_state(st1),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 2, 2, st2,  f_bg_state(st2),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 3, 2, st3,  f_bg_state(st3),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 4, 2, st5,  f_bg_state(st5),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 5, 2, st7,  f_bg_state(st7),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 6, 2, st10, f_bg_state(st10), tc_main, text.align_right, size.tiny)

        vz1 = f_bucket_z(y1_z)
        vz2 = f_bucket_z(y2_z)
        vz3 = f_bucket_z(y3_z)
        vz5 = f_bucket_z(y5_z)
        vz7 = f_bucket_z(y7_z)
        vz10 = f_bucket_z(y10_z)

        f_cell(t_grid, 0, 3, "VALUATION(Z)", bg_row_b, tc_main, text.align_left, size.tiny)
        f_cell(t_grid, 1, 3, vz1,  f_bg_state(vz1),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 2, 3, vz2,  f_bg_state(vz2),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 3, 3, vz3,  f_bg_state(vz3),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 4, 3, vz5,  f_bg_state(vz5),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 5, 3, vz7,  f_bg_state(vz7),  tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 6, 3, vz10, f_bg_state(vz10), tc_main, text.align_right, size.tiny)

        f_cell(t_grid, 0, 4, "MOVE", bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_grid, 1, 4, f_arrow_ascii(chg1),  bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 2, 4, f_arrow_ascii(chg2),  bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 3, 4, f_arrow_ascii(chg3),  bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 4, 4, f_arrow_ascii(chg5),  bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 5, 4, f_arrow_ascii(chg7),  bg_row_a, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 6, 4, f_arrow_ascii(chg10), bg_row_a, tc_main, text.align_right, size.tiny)

        f_cell(t_grid, 0, 5, "STRUCTURE", bg_row_b, tc_main, text.align_left, size.tiny)
        f_cell(t_grid, 1, 5, curve_shift, bg_row_b, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 2, 5, dist_label, f_bg_state(dist_label), tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 3, 5, "FOCUS", bg_row_b, tc_muted, text.align_right, size.tiny)
        f_cell(t_grid, 4, 5, move_focus, bg_row_b, tc_main, text.align_right, size.tiny)
        f_cell(t_grid, 5, 5, "QUAL", bg_row_b, tc_muted, text.align_right, size.tiny)
        f_cell(t_grid, 6, 5, quality_label, f_bg_state(quality_label), tc_main, text.align_right, size.tiny)

        string p2_msg = "TAKEAWAY: " + "Regime=" + yc_code + ", Shift=" + curve_shift + ", Focus=" + move_focus + "."
        if quality_label == "LOWQ"
            p2_msg += " (Noisy)"

        f_cell(t_grid, 0, 8, p2_msg, bg_title, tc_main, text.align_left, size.small)
        for c = 1 to 6
            f_cell(t_grid, c, 8, "", bg_title, tc_main, text.align_left, size.small)
    else
        if not na(t_grid)
            table.delete(t_grid), t_grid := na

    // Panel 3 (kept minimal but meaningful)
    if show_panel3
        if na(t_stats)
            t_stats := table.new(position.top_right, 5, 8,
                 frame_width=2, frame_color=bg_frame,
                 border_width=1, border_color=color.new(color.white, 80))
            table.merge_cells(t_stats, 0, 0, 4, 0)
            table.merge_cells(t_stats, 0, 7, 4, 7)

        f_cell(t_stats, 0, 0, "P3 DIAGNOSTICS (meaning-first)", bg_title, tc_main, text.align_left, size.small)
        for c = 1 to 4
            f_cell(t_stats, c, 0, "", bg_title, tc_main, text.align_left, size.small)

        bar_txt3 = f_bar(macro_stress, 18)
        f_cell(t_stats, 0, 1, "STRESS", bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_stats, 1, 1, f_num_str(macro_stress, "#.0"), f_bg_state(stress_regime), tc_main, text.align_right, size.tiny)
        f_cell(t_stats, 2, 1, bar_txt3, bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_stats, 3, 1, yc_code, f_bg_state(yc_code), tc_main, text.align_right, size.tiny)
        f_cell(t_stats, 4, 1, stress_regime, f_bg_state(stress_regime), tc_main, text.align_left, size.tiny)

        f_cell(t_stats, 0, 2, "LEVEL/SLOPE", bg_row_b, tc_main, text.align_left, size.tiny)
        f_cell(t_stats, 1, 2, level_regime, f_bg_state(level_regime), tc_main, text.align_right, size.tiny)
        f_cell(t_stats, 2, 2, slope_regime, f_bg_state(slope_regime), tc_main, text.align_left, size.tiny)
        f_cell(t_stats, 3, 2, "MOM", bg_row_b, tc_muted, text.align_right, size.tiny)
        f_cell(t_stats, 4, 2, f_arrow_ascii(level_d) + " / " + f_arrow_ascii(slope_d), bg_row_b, tc_main, text.align_left, size.tiny)

        f_cell(t_stats, 0, 3, "QUALITY", bg_row_a, tc_main, text.align_left, size.tiny)
        f_cell(t_stats, 1, 3, f_num_str(signal_quality, "#.0"), f_bg_state(quality_label), tc_main, text.align_right, size.tiny)
        f_cell(t_stats, 2, 3, dist_label, f_bg_state(dist_label), tc_main, text.align_left, size.tiny)
        f_cell(t_stats, 3, 3, "SHIFT", bg_row_a, tc_muted, text.align_right, size.tiny)
        f_cell(t_stats, 4, 3, curve_shift, bg_row_a, tc_main, text.align_left, size.tiny)

        string p3_msg = "MESSAGE: "
        if quality_label == "LOWQ"
            p3_msg += "Noisy -> avoid strong conclusion."
        else
            p3_msg += yc_code + " -> " + yc_label
        f_cell(t_stats, 0, 7, p3_msg, bg_title, tc_main, text.align_left, size.small)
        for c = 1 to 4
            f_cell(t_stats, c, 7, "", bg_title, tc_main, text.align_left, size.small)
    else
        if not na(t_stats)
            table.delete(t_stats), t_stats := na

//======================================================
// 11) ALERTS
//======================================================
alertcondition(yc_code == "YC4" and quality_label != "LOWQ", "YC4 Tight (OK quality)", "YC4 tight regime with usable quality.")
alertcondition(slope_regime == "INVERTED", "Yield curve inverted", "Slope 10-2 is inverted.")
alertcondition(stress_regime == "STRESS CAO" and quality_label != "LOWQ", "Stress High (OK quality)", "Macro stress high with usable quality.")
